/**
 * äº”å­æ£‹æ¸¸æˆä¸»é¡µé¢
 * å®ç°æ£‹ç›˜æ˜¾ç¤ºã€è½å­äº¤äº’ã€æ‚”æ£‹ã€èƒœè´Ÿåˆ¤å®šç­‰åŠŸèƒ½
 */

import { PieceType, GameStatus, DEFAULT_CONFIG, CONFIG_30X30 } from '../model/GameTypes';
import { GameState } from '../model/GameState';
import { AudioManager } from '../model/AudioManager';
import { APP_INFO, BOARD_LAYOUT, SCALE_CONFIG, isStarPoint, getIndices } from '../model/GameConstants';
import { hilog } from '@kit.PerformanceAnalysisKit';

// ç¤¼èŠ±ç²’å­æ¥å£
interface ConfettiItem {
  id: number;
  x: number;
  y: number;
  color: string;
  size: number;
  rotation: number;
  symbol: string;
}

@Entry
@Component
struct Index {
  // æ¸¸æˆçŠ¶æ€ç®¡ç†
  private gameState: GameState = new GameState(DEFAULT_CONFIG);
  private audioManager: AudioManager = AudioManager.getInstance();

  // UIå“åº”å¼çŠ¶æ€
  @State boardData: PieceType[][] = [];
  @State currentPlayer: PieceType = PieceType.BLACK;
  @State gameStatus: GameStatus = GameStatus.PLAYING;
  @State lastMoveRow: number = -1;
  @State lastMoveCol: number = -1;
  @State totalMoves: number = 0;
  @State selectedBoardSize: number = 15;
  @State boardSize: number = 15;
  @State cellSize: number = BOARD_LAYOUT.board15.cellSize;
  @State pieceSize: number = BOARD_LAYOUT.board15.pieceSize;
  @State isMaximized: boolean = false;
  @State soundEnabled: boolean = true;

  // åº†ç¥åŠ¨ç”»çŠ¶æ€
  @State showCelebration: boolean = false;
  @State celebrationText: string = '';
  @State winnerText: string = '';
  @State confettiItems: ConfettiItem[] = [];
  private celebrationTimer: number = -1;

  // å¤¸å¥–è¯­åˆ—è¡¨
  private readonly praises: string[] = [
    'çœŸæ£’ï¼ğŸ‰',
    'å¤ªå‰å®³äº†ï¼ğŸ‘',
    'ç¥ä¹å…¶æŠ€ï¼âœ¨',
    'æ— äººèƒ½æ•Œï¼ğŸ’ª',
    'æ£‹è‰ºè¶…ç¾¤ï¼ğŸ†',
    'å®Œç¾èƒœåˆ©ï¼ğŸŒŸ',
    'å¤©æ‰æ£‹æ‰‹ï¼ğŸ§ ',
    'å®åŠ›è¶…ç¾¤ï¼ğŸ”¥',
    'æˆ˜æ— ä¸èƒœï¼âš”ï¸',
    'éœ¸æ°”åè¶³ï¼ğŸ‘‘',
    'é«˜æ‰‹å¦‚äº‘ï¼â˜ï¸',
    'æŠ€æƒŠå››åº§ï¼ğŸŒ'
  ];

  // ç¼©æ”¾ç›¸å…³çŠ¶æ€ï¼ˆæœ€å¤§åŒ–æ¨¡å¼ä½¿ç”¨ï¼‰
  @State scaleValue: number = 1;
  @State pinchValue: number = 1;
  @State minScale: number = 1.0;
  @State maxScale: number = 2.0;

  // æ‹–åŠ¨ç›¸å…³çŠ¶æ€ï¼ˆæœ€å¤§åŒ–æ¨¡å¼ä½¿ç”¨ï¼‰
  @State offsetX: number = 0;
  @State offsetY: number = 0;
  private panOffsetX: number = 0;
  private panOffsetY: number = 0;

  aboutToAppear(): void {
    this.syncState();
    // è·å– Context å¹¶åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨
    const context = getContext(this);
    this.audioManager.setContext(context);
    this.audioManager.initialize();
  }

  aboutToDisappear(): void {
    this.audioManager.release();
  }

  /**
   * åŒæ­¥æ¸¸æˆçŠ¶æ€åˆ°UI
   */
  private syncState(): void {
    const previousStatus = this.gameStatus;
    
    this.boardData = this.gameState.getBoard();
    this.currentPlayer = this.gameState.getCurrentPlayer();
    this.gameStatus = this.gameState.getGameStatus();
    this.totalMoves = this.gameState.getTotalMoves();

    const lastMove = this.gameState.getLastMove();
    if (lastMove) {
      this.lastMoveRow = lastMove.row;
      this.lastMoveCol = lastMove.col;
    } else {
      this.lastMoveRow = -1;
      this.lastMoveCol = -1;
    }

    // æ£€æµ‹æ˜¯å¦åˆšåˆšè·èƒœï¼Œè§¦å‘åº†ç¥åŠ¨ç”»
    if (previousStatus === GameStatus.PLAYING) {
      if (this.gameStatus === GameStatus.BLACK_WIN) {
        this.triggerCelebration(true);
      } else if (this.gameStatus === GameStatus.WHITE_WIN) {
        this.triggerCelebration(false);
      }
    }
  }

  /**
   * å¤„ç†è½å­äº‹ä»¶
   */
  private handleCellClick(row: number, col: number): void {
    hilog.info(0x0000, 'GamePlay', `Cell clicked: row=${row}, col=${col}`);

    const currentPieceType = this.currentPlayer;

    if (this.gameState.placePiece(row, col)) {
      hilog.info(0x0000, 'GamePlay', `Piece placed at (${row}, ${col})`);
      if (this.soundEnabled) {
        this.audioManager.playPieceSound(currentPieceType);
      }
      this.syncState();
    }
  }

  /**
   * å¤„ç†æ‚”æ£‹äº‹ä»¶
   */
  private handleUndo(): void {
    if (this.gameState.undo()) {
      hilog.info(0x0000, 'GamePlay', 'Undo successful');
      this.syncState();
    }
  }

  /**
   * å¤„ç†é‡æ–°å¼€å§‹äº‹ä»¶
   */
  private handleRestart(): void {
    this.closeCelebration();
    this.gameState.reset();
    this.syncState();
    hilog.info(0x0000, 'GamePlay', 'Game reset');
  }

  /**
   * è§¦å‘åº†ç¥åŠ¨ç”»
   */
  private triggerCelebration(isBlackWin: boolean): void {
    // è®¾ç½®è·èƒœè€…æ–‡æœ¬
    this.winnerText = isBlackWin ? 'â¬› é»‘æ–¹è·èƒœï¼' : 'â¬œ ç™½æ–¹è·èƒœï¼';
    
    // éšæœºé€‰æ‹©å¤¸å¥–è¯­
    const randomIndex = Math.floor(Math.random() * this.praises.length);
    this.celebrationText = this.praises[randomIndex];
    
    // ç”Ÿæˆç¤¼èŠ±ç²’å­
    this.generateConfetti();
    
    // æ˜¾ç¤ºåº†ç¥å¼¹çª—
    this.showCelebration = true;
    
    // 5ç§’åè‡ªåŠ¨å…³é—­
    this.celebrationTimer = setTimeout(() => {
      this.showCelebration = false;
    }, 5000) as number;
  }

  /**
   * ç”Ÿæˆç¤¼èŠ±ç²’å­
   */
  private generateConfetti(): void {
    const colors = [
      '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', 
      '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', 
      '#85C1E9', '#FF69B4', '#00CED1', '#FF4500', '#32CD32'
    ];
    const symbols = ['âœ¨', 'â­', 'ğŸŒŸ', 'â™¥', 'â—†', 'â—', 'ğŸ’', 'ğŸŒˆ'];
    const items: ConfettiItem[] = [];
    
    // åˆ›å»ºæ›´å¤šç²’å­ï¼Œå‡åŒ€åˆ†å¸ƒ
    for (let i = 0; i < 100; i++) {
      items.push({
        id: i,
        x: Math.random() * 100,
        y: Math.random() * 100,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: 14 + Math.random() * 22,
        rotation: Math.random() * 360,
        symbol: symbols[Math.floor(Math.random() * symbols.length)]
      });
    }
    
    this.confettiItems = items;
  }

  /**
   * å…³é—­åº†ç¥å¼¹çª—
   */
  private closeCelebration(): void {
    this.showCelebration = false;
    if (this.celebrationTimer !== -1) {
      clearTimeout(this.celebrationTimer);
      this.celebrationTimer = -1;
    }
  }

  /**
   * è·å–çŠ¶æ€æ–‡æœ¬
   */
  private getStatusText(): string {
    switch (this.gameStatus) {
      case GameStatus.BLACK_WIN:
        return 'é»‘æ–¹è·èƒœï¼';
      case GameStatus.WHITE_WIN:
        return 'ç™½æ–¹è·èƒœï¼';
      case GameStatus.DRAW:
        return 'å¹³å±€ï¼';
      default:
        return this.currentPlayer === PieceType.BLACK ? 'é»‘æ–¹å›åˆ' : 'ç™½æ–¹å›åˆ';
    }
  }

  /**
   * åˆ‡æ¢æ£‹ç›˜å°ºå¯¸
   */
  private switchBoardSize(size: number): void {
    if (size === this.boardSize) return;

    this.selectedBoardSize = size;
    this.boardSize = size;
    this.isMaximized = false;
    this.resetTransform();

    if (size === 30) {
      this.cellSize = BOARD_LAYOUT.board30.baseCellSize;
      this.pieceSize = BOARD_LAYOUT.board30.basePieceSize;
      this.gameState = new GameState(CONFIG_30X30);
    } else {
      this.cellSize = BOARD_LAYOUT.board15.cellSize;
      this.pieceSize = BOARD_LAYOUT.board15.pieceSize;
      this.gameState = new GameState(DEFAULT_CONFIG);
    }

    this.syncState();
    hilog.info(0x0000, 'GamePlay', `Board size changed to: ${size}`);
  }

  /**
   * åˆ‡æ¢æœ€å¤§åŒ–æ¨¡å¼
   */
  private toggleMaximize(): void {
    this.isMaximized = !this.isMaximized;

    if (this.isMaximized) {
      const config = this.boardSize === 30 ? SCALE_CONFIG.scale30 : SCALE_CONFIG.scale15;
      this.scaleValue = config.defaultValue;
      this.minScale = config.min;
      this.maxScale = config.max;
      this.pinchValue = this.scaleValue;
    } else {
      this.resetTransform();
    }

    hilog.info(0x0000, 'GamePlay', `Maximize mode: ${this.isMaximized}`);
  }

  /**
   * é‡ç½®å˜æ¢çŠ¶æ€
   */
  private resetTransform(): void {
    this.scaleValue = 1;
    this.pinchValue = 1;
    this.offsetX = 0;
    this.offsetY = 0;
    this.panOffsetX = 0;
    this.panOffsetY = 0;
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹
      Column() {
      // æ ‡é¢˜åŒºåŸŸï¼ˆéæœ€å¤§åŒ–æ¨¡å¼ï¼‰
      if (!this.isMaximized) {
        Text('FiveInRowäº’åŠ¨äº”å­æ£‹')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.primary_text'))
          .margin({ top: 20, bottom: 10 })

        // æ£‹ç›˜å°ºå¯¸é€‰æ‹©
        Row() {
          Text('æ£‹ç›˜å°ºå¯¸:')
            .fontSize(14)
            .fontColor($r('app.color.secondary_text'))
            .margin({ right: 10 })

          Button('15Ã—15')
            .fontSize(14)
            .fontColor(this.selectedBoardSize === 15 ? $r('app.color.button_text') : $r('app.color.primary_text'))
            .backgroundColor(this.selectedBoardSize === 15 ? $r('app.color.button_primary') : '#E0E0E0')
            .width(80)
            .height(32)
            .borderRadius(16)
            .onClick(() => this.switchBoardSize(15))

          Button('30Ã—30')
            .fontSize(14)
            .fontColor(this.selectedBoardSize === 30 ? $r('app.color.button_text') : $r('app.color.primary_text'))
            .backgroundColor(this.selectedBoardSize === 30 ? $r('app.color.button_primary') : '#E0E0E0')
            .width(80)
            .height(32)
            .borderRadius(16)
            .margin({ left: 10 })
            .onClick(() => this.switchBoardSize(30))
        }
        .margin({ bottom: 5 })

        // æœ€å¤§åŒ–å’Œå£°éŸ³å¼€å…³
        Row() {
          Button('æœ€å¤§åŒ–')
            .fontSize(14)
            .fontColor($r('app.color.button_text'))
            .backgroundColor('#FF6B35')
            .width(80)
            .height(32)
            .borderRadius(16)
            .onClick(() => this.toggleMaximize())

          Button(this.soundEnabled ? 'å£°éŸ³ å¼€' : 'å£°éŸ³ å…³')
            .fontSize(14)
            .fontColor($r('app.color.button_text'))
            .backgroundColor(this.soundEnabled ? '#4CAF50' : '#9E9E9E')
            .width(80)
            .height(32)
            .borderRadius(16)
            .margin({ left: 10 })
            .onClick(() => {
              this.soundEnabled = !this.soundEnabled;
              this.audioManager.setSoundEnabled(this.soundEnabled);
            })
        }
        .margin({ bottom: 10 })

        // çŠ¶æ€æ˜¾ç¤º
        Row() {
          if (this.gameStatus === GameStatus.PLAYING) {
            Circle({ width: 24, height: 24 })
              .fill(this.currentPlayer === PieceType.BLACK ?
                $r('app.color.black_turn_indicator') : $r('app.color.white_turn_indicator'))
              .stroke($r('app.color.board_line'))
              .strokeWidth(1)
              .margin({ right: 8 })
          }

          Text(this.getStatusText())
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.gameStatus !== GameStatus.PLAYING ?
              $r('app.color.win_color') : $r('app.color.primary_text'))
        }
        .margin({ bottom: 10 })

        Text(`æ€»æ­¥æ•°: ${this.totalMoves}`)
          .fontSize(14)
          .fontColor($r('app.color.secondary_text'))
          .margin({ bottom: this.boardSize === 30 ? 5 : 15 })
      }

      // æœ€å¤§åŒ–æ¨¡å¼ï¼šç®€åŒ–çŠ¶æ€æ 
      if (this.isMaximized) {
        Row() {
          Button('é€€å‡ºæœ€å¤§åŒ–')
            .fontSize(12)
            .fontColor($r('app.color.button_text'))
            .backgroundColor('#FF6B35')
            .height(28)
            .borderRadius(14)
            .margin({ right: 15 })
            .onClick(() => this.toggleMaximize())

          if (this.gameStatus === GameStatus.PLAYING) {
            Circle({ width: 20, height: 20 })
              .fill(this.currentPlayer === PieceType.BLACK ?
                $r('app.color.black_turn_indicator') : $r('app.color.white_turn_indicator'))
              .stroke($r('app.color.board_line'))
              .strokeWidth(1)
              .margin({ right: 6 })
          }

          Text(this.getStatusText())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.gameStatus !== GameStatus.PLAYING ?
              $r('app.color.win_color') : $r('app.color.primary_text'))

          Text(` | ${(this.scaleValue * 100).toFixed(0)}%`)
            .fontSize(12)
            .fontColor($r('app.color.secondary_text'))
            .margin({ left: 10 })

          Text(' | åŒæŒ‡ç¼©æ”¾/ä¸‰æŒ‡ç§»åŠ¨')
            .fontSize(11)
            .fontColor('#888888')
            .margin({ left: 8 })
        }
        .margin({ top: 0, bottom: 0 })
      }

      // éæœ€å¤§åŒ–30è·¯ç¼©æ”¾æç¤º
      if (!this.isMaximized && this.boardSize === 30) {
        Text(`åŒæŒ‡ç¼©æ”¾: ${(this.scaleValue * 100).toFixed(0)}% | æ”¯æŒä¸‰æŒ‡æ‹–æ‹½ç§»åŠ¨`)
          .fontSize(12)
          .fontColor($r('app.color.secondary_text'))
          .margin({ bottom: 10 })
      }

      // æ£‹ç›˜åŒºåŸŸ
      if (this.isMaximized || this.boardSize === 30) {
        this.ScalableBoard()
      } else {
        this.StaticBoard()
      }

      // æ“ä½œæŒ‰é’®
      Row() {
        Button('æ‚”æ£‹')
          .fontSize(this.isMaximized ? 14 : 16)
          .fontColor($r('app.color.button_text'))
          .backgroundColor($r('app.color.button_secondary'))
          .width(this.isMaximized ? 80 : 100)
          .height(this.isMaximized ? 36 : 44)
          .borderRadius(this.isMaximized ? 18 : 22)
          .enabled(this.totalMoves > 0 && this.gameStatus === GameStatus.PLAYING)
          .opacity(this.totalMoves > 0 && this.gameStatus === GameStatus.PLAYING ? 1 : 0.5)
          .onClick(() => this.handleUndo())

        Button('é‡æ–°å¼€å§‹')
          .fontSize(this.isMaximized ? 14 : 16)
          .fontColor($r('app.color.button_text'))
          .backgroundColor($r('app.color.button_primary'))
          .width(this.isMaximized ? 100 : 120)
          .height(this.isMaximized ? 36 : 44)
          .borderRadius(this.isMaximized ? 18 : 22)
          .margin({ left: 20 })
          .enabled(this.totalMoves > 0)
          .opacity(this.totalMoves > 0 ? 1 : 0.5)
          .onClick(() => this.handleRestart())
      }
      .margin({ bottom: this.isMaximized ? 0 : (this.boardSize === 30 ? 10 : 20) })

      // ç‰ˆæœ¬ä¿¡æ¯ï¼ˆéæœ€å¤§åŒ–æ¨¡å¼ï¼‰
      if (!this.isMaximized) {
        Column() {
          Text(`v${APP_INFO.version}`)
            .fontSize(12)
            .fontColor($r('app.color.secondary_text'))
            .margin({ bottom: 4 })

          Text(`ä½œè€…: ${APP_INFO.author}`)
            .fontSize(11)
            .fontColor($r('app.color.secondary_text'))
            .margin({ bottom: 2 })

          Text(APP_INFO.email)
            .fontSize(10)
            .fontColor($r('app.color.secondary_text'))
        }
        .margin({ bottom: this.boardSize === 30 ? 10 : 15 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.page_background'))
    .justifyContent(FlexAlign.Start)
    .alignItems(HorizontalAlign.Center)

      // åº†ç¥å¼¹çª—å±‚
      if (this.showCelebration) {
        Stack() {
          // åŠé€æ˜èƒŒæ™¯
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('#99000000')
            .onClick(() => this.closeCelebration())

          // ç¤¼èŠ±ç²’å­
          ForEach(this.confettiItems, (item: ConfettiItem) => {
            Text(item.symbol)
              .fontSize(item.size)
              .fontColor(item.color)
              .position({ x: `${item.x}%`, y: `${item.y}%` })
              .rotate({ angle: item.rotation })
              .opacity(0.85)
              .shadow({ radius: 8, color: item.color, offsetX: 0, offsetY: 0 })
          })

          // ä¸­å¿ƒå†…å®¹å¡ç‰‡
          Column() {
            // è·èƒœè€…æ–‡æœ¬
            Text(this.winnerText)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
              .margin({ bottom: 16 })
              .textShadow({ radius: 10, color: '#000000', offsetX: 2, offsetY: 2 })

            // å¤¸å¥–è¯­
            Text(this.celebrationText)
              .fontSize(52)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFD700')
              .margin({ bottom: 30 })
              .textShadow({ radius: 15, color: '#FF8C00', offsetX: 0, offsetY: 0 })

            // åˆ†å‰²çº¿
            Row()
              .width(120)
              .height(3)
              .backgroundColor('#FFD700')
              .borderRadius(2)
              .margin({ bottom: 30 })

            // å†æ¥ä¸€å±€æŒ‰é’®
            Button('ğŸ® å†æ¥ä¸€å±€')
              .fontSize(18)
              .fontColor('#FFFFFF')
              .backgroundColor('#4CAF50')
              .width(180)
              .height(55)
              .borderRadius(28)
              .shadow({ radius: 15, color: '#2E7D32', offsetX: 0, offsetY: 5 })
              .onClick(() => {
                this.closeCelebration();
                this.handleRestart();
              })
          }
          .padding(40)
          .backgroundColor('#CC000000')
          .borderRadius(24)
          .shadow({ radius: 30, color: '#000000', offsetX: 0, offsetY: 10 })
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
  }

  /**
   * å¯ç¼©æ”¾æ£‹ç›˜ï¼ˆæœ€å¤§åŒ–æˆ–30è·¯ï¼‰
   */
  @Builder
  ScalableBoard() {
    Stack() {
      Column() {
        ForEach(getIndices(this.boardSize), (row: number) => {
          Row() {
            ForEach(getIndices(this.boardSize), (col: number) => {
              this.BoardCell(row, col)
            })
          }
        })
      }
      .backgroundColor($r('app.color.board_background'))
      .padding(BOARD_LAYOUT.padding)
      .borderRadius(8)
      .shadow({ radius: 10, color: '#33000000', offsetX: 2, offsetY: 4 })
      .scale({ x: this.scaleValue, y: this.scaleValue })
      .translate({ x: this.offsetX, y: this.offsetY })
    }
    .width('100%')
    .height('100%')
    .clip(true)
    .gesture(
      GestureGroup(GestureMode.Exclusive,
        // ä¸‰æŒ‡ç§»åŠ¨æ‰‹åŠ¿ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼Œæ”¾åœ¨å‰é¢ï¼‰
        PanGesture({ fingers: 3, direction: PanDirection.All })
          .onActionStart(() => {
            this.panOffsetX = this.offsetX;
            this.panOffsetY = this.offsetY;
          })
          .onActionUpdate((event: GestureEvent) => {
            if (event) {
              this.offsetX = this.panOffsetX + (event.offsetX || 0);
              this.offsetY = this.panOffsetY + (event.offsetY || 0);
            }
          })
          .onActionEnd(() => {
            this.panOffsetX = this.offsetX;
            this.panOffsetY = this.offsetY;
          }),
        // åŒæŒ‡ç¼©æ”¾æ‰‹åŠ¿
        PinchGesture({ fingers: 2 })
          .onActionStart(() => { this.pinchValue = this.scaleValue; })
          .onActionUpdate((event: GestureEvent) => {
            if (event?.scale) {
              const config = this.boardSize === 30 ? SCALE_CONFIG.scale30 : SCALE_CONFIG.scale15;
              let newScale = this.pinchValue * event.scale;
              this.scaleValue = Math.max(config.min, Math.min(config.max, newScale));
            }
          })
          .onActionEnd(() => { this.pinchValue = this.scaleValue; })
      )
    )
    .layoutWeight(1)
    .margin({ bottom: this.isMaximized ? 0 : 10 })
  }

  /**
   * é™æ€æ£‹ç›˜ï¼ˆ15è·¯éæœ€å¤§åŒ–ï¼‰
   */
  @Builder
  StaticBoard() {
    Stack() {
      Column() {
        ForEach(getIndices(this.boardSize), (row: number) => {
          Row() {
            ForEach(getIndices(this.boardSize), (col: number) => {
              this.BoardCell(row, col)
            })
          }
        })
      }
      .backgroundColor($r('app.color.board_background'))
      .padding(BOARD_LAYOUT.padding)
      .borderRadius(8)
      .shadow({ radius: 10, color: '#33000000', offsetX: 2, offsetY: 4 })
    }
    .margin({ bottom: 20 })
  }

  /**
   * æ£‹ç›˜å•å…ƒæ ¼
   */
  @Builder
  BoardCell(row: number, col: number) {
    Stack() {
      Canvas(new CanvasRenderingContext2D(new RenderingContextSettings(true)))
        .width(this.cellSize)
        .height(this.cellSize)
        .onReady(() => { })

      // æ°´å¹³çº¿
      Column() {
        if (row > 0 || row < this.boardSize - 1) {
          Line()
            .width(col === 0 ? this.cellSize / 2 : (col === this.boardSize - 1 ? this.cellSize / 2 : this.cellSize))
            .height(1)
            .backgroundColor($r('app.color.board_line'))
            .position({
              x: col === 0 ? this.cellSize / 2 : 0,
              y: this.cellSize / 2
            })
        }
      }
      .width(this.cellSize)
      .height(this.cellSize)

      // å‚ç›´çº¿
      Column() {
        Line()
          .width(1)
          .height(row === 0 ? this.cellSize / 2 : (row === this.boardSize - 1 ? this.cellSize / 2 : this.cellSize))
          .backgroundColor($r('app.color.board_line'))
          .position({
            x: this.cellSize / 2,
            y: row === 0 ? this.cellSize / 2 : 0
          })
      }
      .width(this.cellSize)
      .height(this.cellSize)

      // æ˜Ÿä½
      if (isStarPoint(row, col, this.boardSize)) {
        Circle({ width: this.boardSize === 30 ? 4 : 6, height: this.boardSize === 30 ? 4 : 6 })
          .fill($r('app.color.star_point'))
      }

      // æ£‹å­
      if (this.boardData.length > row && this.boardData[row].length > col) {
        if (this.boardData[row][col] !== PieceType.EMPTY) {
          Circle({ width: this.pieceSize, height: this.pieceSize })
            .fill(this.boardData[row][col] === PieceType.BLACK ?
              $r('app.color.black_piece') : $r('app.color.white_piece'))
            .stroke(this.boardData[row][col] === PieceType.BLACK ? '#333333' : 'transparent')
            .strokeWidth(this.boardData[row][col] === PieceType.BLACK ? 1 : 0)

          if (row === this.lastMoveRow && col === this.lastMoveCol) {
            Circle({ width: this.boardSize === 30 ? 4 : 6, height: this.boardSize === 30 ? 4 : 6 })
              .fill($r('app.color.last_move_marker'))
          }
        }
      }
    }
    .width(this.cellSize)
    .height(this.cellSize)
    .onClick(() => { this.handleCellClick(row, col); })
  }
}
